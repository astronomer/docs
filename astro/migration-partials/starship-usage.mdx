import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Airflow can get Connections and Variables from multiple sources:

- The Airflow UI (stored in the Airflow Metadata Database)
- Environmental Variables
- A Secrets Backend

If your Airflow contains connections or variables in the Metadata Database, which you can observe in `Admin > Connections` (or `Admin > Variables`), you can
migrate those to Astro with Starship.

<Tabs>
<TabItem value="plugin" label="Starship Plugin" default>

1. Once your source environment installs `astronomer-starship` via the `requirements.txt`, you will see a new Astronomer menu. Hover over that menu and select the `Migration Tool üöÄ` option
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/menu-item.png"></img>
</details>

2. After opening the plugin page, you will need to authenticate to Astronomer. To do this, please:
    1. Click the `Get Token` button
    2. If you are prompted to sign-in to cloud.astronomer.io please do so
    3. Copy the access token that appears in the new tab
    4. Paste the access token into the `Authentication Token` field
    5. Click the `Sign In` button

3. After authenticating to Astronomer, you will need to select the deployment that you are sending metadata to. To do this, select a deployment from the `Target Deployment` dropdown and click the `Select` button


#### Migrating Airflow Connections

To migrate connections from your source Airflow meta-database:

1. Click on the `Connections` tab:
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/connections-tab.png"></img>
</details>

2. In the table displaying the connections that can be migrated, click the `Migrate` button for each connection that needs to be sent to the Target Deployment:
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/connections-migrate.png"></img>
</details>

3. Once the `Migrate` button is clicked, the connection will be sent to the Target Deployment and will show as `Migrated ‚úÖ` in the plugin UI:
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/connections-migrate-complete.png"></img>
</details>

#### Migrating Airflow Variables

To migrate variables from your source Airflow meta-database:

1. Click on the `Variables` tab:
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/variables-tab.png"></img>
</details>

2. In the table displaying the variables that can be migrated, click the `Migrate` button for each connection that needs to be sent to the Target Deployment
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/variables-migrate.png"></img>
</details>

3. Once the `Migrate` button is clicked, the variable will be sent to the Target Deployment and will show as `Migrated ‚úÖ` in the plugin UI:
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/variables-migrate-complete.png"></img>
</details>

#### Migrating Environment Variables
:::caution
Not all Environmental Variables or Airflow Settings are [configurable on Astro](https://docs.astronomer.io/astro/platform-variables)
:::

To migrate environment variables from your source Airflow:

1. Click on the `Environment Variables` tab:
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/env-tab.png"></img>
</details>

2. In the table displaying the environment variables that can be migrated, ensure the checkbox is ticked for each environment variable that needs to be sent to the Target Deployment
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/env-migrate.png"></img>
</details>

3. Once all of the desired environment variable checkboxes have been selected, click the `Migrate` button in the table header
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/env-migrate-button.png"></img>
</details>

4. After clicking the `Migrate` button in the table header, each selected environment variable will be sent to the Target Deployment and the ticked checkbox will display `Migrated `‚úÖ
<details>
    <img src="https://github.com/astronomer/starship/raw/master/astronomer-starship/images/env-migrate-complete.png"></img>
</details>

</TabItem>
<TabItem value="operator" label="Starship Operator">

:::info

Refer to the [Configuration](https://github.com/astronomer/starship/tree/master/astronomer-starship-provider#configuration) instructions for the operator before running.

:::
:::caution

Not all Environmental Variables or Airflow Settings are [configurable on Astro](https://docs.astronomer.io/astro/platform-variables)

:::

1. Add the following DAG to your source environment:
    ```python
    from airflow import DAG
    from astronomer.starship.operators import AstroMigrationOperator
    from datetime import datetime

    with DAG(
      dag_id="astronomer_migration_dag",
      start_date=datetime(1970, 1, 1),
      schedule_interval=None,
    ) as dag:
      AstroMigrationOperator(
          task_id='export_meta',
          deployment_url='{{ dag_run.conf["deployment_url"] }}',
          token='{{ dag_run.conf["astro_token"] }}',
      )
    ```
2. Deploy this DAG to your source Airflow environment
3. Once the DAG is available in the Airflow UI, click the "Trigger DAG" ‚ñ∂Ô∏è button, then click "Trigger DAG w/ config", and input the following in the configuration dictionary:

    - `astro_token`:  To retrieve an Astronomer token, navigate to [cloud.astronomer.io/token](https://cloud.astronomer.io/token) and log in using your Astronomer credentials
    - `deployment_url`: To retrieve a deployment URL - navigate to the Astronomer Airlow deployment that you'd like to migrate to in the Astronomer UI, click `Open Airflow` and copy the page URL (excluding `/home` on the end of the URL). For example, if your deployment URL is `https://astronomer.astronomer.run/abcdt4ry/home`, you'll use `https://astronomer.astronomer.run/abcdt4ry`

    The config dictionary used when triggering the DAG should be formatted as:
    ```json
    {
        "deployment_url": "your-deployment-url",
        "astro_token": "your-astro-token"
    }
    ```
4. Once the DAG successfully runs, your connections, variables, and environment variables should all be migrated to Astronomer

</TabItem>
</Tabs>